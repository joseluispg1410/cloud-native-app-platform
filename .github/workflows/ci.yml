name: Build & Deploy to AKS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  ACR_NAME: acrdemodemo123
  IMAGE_NAME: demo-app
  CLUSTER_NAME: aks-demo
  RESOURCE_GROUP: rg-aks-demo
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # UNIT TESTS
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: ./app
        run: |
          cd app
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          cd app
          pytest tests || true
        # (para demo puedes permitir fallo; en real quitar el || true)

      # -------------------------
      # AZURE LOGIN
      # -------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -------------------------
      # DOCKER BUILD & PUSH
      # -------------------------
      - name: Login to ACR
        run: az acr login --name $ACR_NAME

      - name: Build and Push image
        run: |
          docker build \
            --platform linux/amd64 \
            -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
            ./app

          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG

      # -------------------------
      # AKS DEPLOY WITH HELM
      # -------------------------
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group $RESOURCE_GROUP \
            --name $CLUSTER_NAME \
            --overwrite-existing

      - name: Deploy with Helm
        run: |
          helm upgrade --install demo-app ./helm/app \
            --set image.repository=$ACR_NAME.azurecr.io/$IMAGE_NAME \
            --set image.tag=$IMAGE_TAG
